<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è‚¡ç¥¨æŠ€è¡“æŒ‡æ¨™åœ–</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <h2>ğŸ“ˆ è‚¡ç¥¨æŠ€è¡“æŒ‡æ¨™åˆ†æ</h2>
  <form method="POST">
    <label>è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼š</label>
    <input type="text" name="symbol" value="{{ symbol }}" required>
    <button type="submit">æŸ¥è©¢</button>
  </form>

  {% if result %}
    <h3>ğŸ“Œ æ¨¡å‹é æ¸¬å»ºè­°ï¼š{{ result }}</h3>
  {% endif %}

  {% if report_html %}
  <h3>ğŸ“Š æ¨¡å‹æ•ˆèƒ½å ±å‘Šï¼š</h3>
  {{ report_html | safe }}
  {% endif %}
  {% if model_reports %}
  <h3>ğŸ“Š ä¸‰ç¨®æ¨¡å‹æ¯”è¼ƒï¼š</h3>
  {% for name, report in model_reports.items() %}
    <h4>{{ name }}</h4>
    {{ report | safe }}
  {% endfor %}
{% endif %}

  <div>
    <label>ğŸ“Š é¡¯ç¤ºç·šæ¢ï¼š</label><br>
    <input type="checkbox" class="indicator-toggle" value="æ”¶ç›¤åƒ¹" checked> æ”¶ç›¤åƒ¹
    <input type="checkbox" class="indicator-toggle" value="ä¸Šå¸ƒæ—" checked> ä¸Šå¸ƒæ—
    <input type="checkbox" class="indicator-toggle" value="ä¸‹å¸ƒæ—" checked> ä¸‹å¸ƒæ—
    <input type="checkbox" class="indicator-toggle" value="è²»æ³¢é‚£å¥‘" checked> è²»æ³¢é‚£å¥‘
    <input type="checkbox" class="indicator-toggle" value="RSI" checked> RSI
    <input type="checkbox" class="indicator-toggle" value="MACD" checked> MACD
    <input type="checkbox" class="indicator-toggle" value="MACD_Signal" checked> MACD_Signal
    <input type="checkbox" class="indicator-toggle" value="OBV" checked> OBV
  </div>

  <div id="chart" style="width:100%;height:1000px;"></div>

  <script>
    const data = JSON.parse(`{{ chart_data | tojson | safe }}`);
    const dates = data.Date;
    const traces = [];

    function createTrace(name, y, color, xaxis, yaxis, dash = 'solid') {
      return {
        x: dates,
        y: y,
        name: name,
        mode: 'lines',
        line: { color: color, width: 2, dash: dash },
        xaxis: xaxis,
        yaxis: yaxis,
        visible: true
      };
    }

    traces.push(createTrace('æ”¶ç›¤åƒ¹', data.Close, 'black', 'x1', 'y1'));
    traces.push(createTrace('ä¸Šå¸ƒæ—', data.Bollinger_Upper, 'blue', 'x1', 'y1', 'dot'));
    traces.push(createTrace('ä¸‹å¸ƒæ—', data.Bollinger_Lower, 'blue', 'x1', 'y1', 'dot'));
    traces.push(createTrace('è²»æ³¢é‚£å¥‘', data.Fibonacci_0618, 'purple', 'x1', 'y1'));

    traces.push(createTrace('RSI', data.RSI, 'orange', 'x2', 'y2'));
    traces.push(createTrace('MACD', data.MACD, 'green', 'x2', 'y2'));
    traces.push(createTrace('MACD_Signal', data.MACD_Signal, 'red', 'x2', 'y2', 'dash'));

    traces.push(createTrace('OBV', data.OBV, 'brown', 'x3', 'y3'));

    const layout = {
      title: 'ğŸ“Š è‚¡ç¥¨æŠ€è¡“åˆ†æï¼ˆä¸‰åœ–åŒæ­¥ + ç·šæ¢æ§åˆ¶ï¼‰',
      grid: { rows: 3, columns: 1, pattern: 'independent' },
      height: 1000,
      showlegend: true,
      xaxis: { domain: [0, 1], anchor: 'y1', matches: 'x', title: 'æ—¥æœŸ' },
      yaxis: { domain: [0.66, 1.0], title: 'åƒ¹æ ¼' },
      xaxis2: { domain: [0, 1], anchor: 'y2', matches: 'x' },
      yaxis2: { domain: [0.33, 0.66], title: 'æŠ€è¡“æŒ‡æ¨™' },
      xaxis3: { domain: [0, 1], anchor: 'y3', matches: 'x' },
      yaxis3: { domain: [0.0, 0.33], title: 'OBV' },
      legend: { orientation: 'h', x: 0, y: -0.25 }
    };

    Plotly.newPlot('chart', traces, layout);

    // é–‹é—œç·šæ¢åŠŸèƒ½
    document.querySelectorAll('.indicator-toggle').forEach((checkbox) => {
      checkbox.addEventListener('change', () => {
        const name = checkbox.value;
        const visible = checkbox.checked ? true : 'legendonly';
        for (let i = 0; i < traces.length; i++) {
          if (traces[i].name === name) {
            Plotly.restyle('chart', { visible: visible }, [i]);
          }
        }
      });
    });
  </script>

</body>
</html>
